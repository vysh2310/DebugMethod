name: Polyspace Action Demo
on: [push]
env:
  PRJNAME: DebugMethodGit
  RESULTS_DIR: results
  ACCESS_HOST: psaccessp00gnb.mathworks.com
  ACCESS_PATH: "/public/DebugMethodGit"
  ACCESS_PASS: JDAJJPFAEMJFIKNGDNINHFPGKDGBDPLD
   SMTP_USERNAME:vhanumap
   SMTP_PASSWORD:Baby*02putani
   
jobs: 
  Polyspace-GitHubActions:
    runs-on: [self-hosted, windows, x64, polyspace]
    steps:
    - name: Check out repository code
      uses: actions/checkout@v2
    - name: Ensure Env
      run: |
        echo "PATH=C:/Program Files/Polyspace/R2023a/polyspace/bin:$PATH" >> $GITHUB_ENV
        echo "The job was automatically triggered by a ${{ github.event_name }} event."
        echo "This job is now running on a ${{ runner.os }} server hosted by GitHub!"
        echo "The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."  
    - name: Run analysis
      run: |
        echo "Running Polyspace analysis..."
        polyspace-bug-finder -sources C:/DebugGit/DebugMethod/Debugging.c -misra3 all -checkers all -results-dir ${{ env.RESULTS_DIR }}   
        echo "This job's status is done"
        polyspace-results-export -format csv -results-dir ${{ env.RESULTS_DIR }}  -output-name ${{ env.PRJNAME }}.csv
        
    - name: Send Email Notification     
      uses: dawidd6/action-send-mail@v2        
      with:      
          server_address: mail.mathworks.com
          server_port: 25
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: Workflow Completed
          body: 'The GitHub Actions workflow has completed successfully and has found defects'
          to: vhanumap@example.com
          from: vhanumap@example.com
          attachment_path: '${{ env.PRJNAME }}.csv'
          
    - name: Upload to Polypace Access Dashboard
      run: |
        echo "Uploading Polyspace analysis..."
        polyspace-access -protocol http -host ${{ env.ACCESS_HOST }} -port 9443 -login vhanumap -encrypted-password ${{ env.ACCESS_PASS }} -create-project ${{ env.ACCESS_PATH }}
        polyspace-access -protocol http -host ${{ env.ACCESS_HOST }} -port 9443 -login vhanumap -encrypted-password ${{ env.ACCESS_PASS }} -upload ${{ env.RESULTS_DIR }} -parent-project ${{ env.ACCESS_PATH }} -project ${{ env.PRJNAME }}
